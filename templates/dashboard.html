{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Painel ‚Äì Gerador de Conte√∫do com IA</title>
    <!-- Depois vamos ligar este CSS -->
    <link rel="stylesheet" href="{% static 'css/painel.css' %}">
</head>

<body class="app-body">
    <header class="app-header">
        <div class="app-header__logo">
            <span class="app-header__logo-icon">IA</span>
            <span class="app-header__logo-text">Gerador de Conte√∫do</span>
            <span class="plan-badge" id="plan-badge"></span>
        </div>
        <nav class="app-header__nav">
            <span class="app-header__nav-item is-active" id="nav-painel">Painel</span>
            <span class="app-header__nav-item" id="nav-historico">Hist√≥rico</span>
            <span class="app-header__nav-item" id="btn-logout">Sair</span>

        </nav>
    </header>

    <main class="app-main-wrapper">
        <div id="trial-banner-slot"></div>
        <div class="app-tabs">
            <div class="app-tabs__nav">
                <button class="app-tabs__button is-active" data-tab="tab-gerar">
                    ‚úçÔ∏è Gerar conte√∫do
                </button>
                <button class="app-tabs__button" data-tab="tab-historico">
                    üìú Hist√≥rico de conte√∫dos
                </button>
                <button class="app-tabs__button" data-tab="tab-sobre">
                    ‚ÑπÔ∏è Sobre o app
                </button>

            </div>

            <!-- ABA 1: GERAR CONTE√öDO -->
            <div class="app-tab-pane" id="tab-gerar">
                <div class="app-main">
                    <section class="app-panel">
                        <div class="app-panel__header">
                            <h1 class="app-panel__title">Crie posts prontos para divulgar seu neg√≥cio em segundos</h1>
                            <p class="appp-panel">Sem saber marketing. Sem perder tempo. Copiou, postou.</p>
                            <p class="app-panel__subtitle">
                                Preencha o briefing abaixo e gere textos prontos para redes sociais, blog ou v√≠deos
                                curtos.
                            </p>
                        </div>

                        <div class="usage-indicator" id="usage-indicator">
                            <span class="usage-text">
                                Uso do m√™s:
                                <strong id="usage-used">0</strong>
                                de
                                <strong id="usage-limit">0</strong>
                                conte√∫dos
                            </span>
                        </div>


                        <!-- FORMUL√ÅRIO (o mesmo que j√° est√° usando) -->
                        <form class="form-briefing" id="form-briefing">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="nicho">Nicho / Tipo de neg√≥cio *</label>
                                    <input type="text" id="nicho" name="nicho"
                                        placeholder="Ex: cl√≠nica de psicologia, consult√≥rio odontol√≥gico, empresa de ar-condicionado..."
                                        required>
                                </div>
                                <div class="form-group">
                                    <label for="tema">Tema do conte√∫do *</label>
                                    <input type="text" id="tema" name="tema"
                                        placeholder="Ex: ansiedade, manuten√ß√£o preventiva de ar-condicionado, alimenta√ß√£o saud√°vel..."
                                        required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="plataforma">Plataforma *</label>
                                    <select id="plataforma" name="plataforma" required>
                                        <option value="">Selecione uma plataforma...</option>
                                        <option>Instagram (feed)</option>
                                        <option>Instagram Reels</option>
                                        <option>Facebook (feed)</option>
                                        <option>LinkedIn</option>
                                        <option>Blog</option>
                                        <option>YouTube (descri√ß√£o de v√≠deo)</option>
                                        <option>YouTube Shorts</option>
                                        <option>TikTok (v√≠deo curto)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="tom">Tom *</label>
                                    <select id="tom" name="tom" required>
                                        <option value="">Selecione o tom...</option>
                                        <option>Normal</option>
                                        <option>Informativo</option>
                                        <option>Inspirador</option>
                                        <option>Urgente</option>
                                        <option>Informal</option>
                                        <option>Educativo</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="tamanho">Tamanho</label>
                                    <select id="tamanho" name="tamanho">
                                        <option>Curto</option>
                                        <option>M√©dio</option>
                                        <option>Longo</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="publico">P√∫blico-alvo</label>
                                    <select id="publico" name="publico">
                                        <option>Geral</option>
                                        <option>Jovens adultos</option>
                                        <option>Fam√≠lias</option>
                                        <option>Idosos</option>
                                        <option>Adolescentes</option>
                                        <option>Empres√°rios</option>
                                        <option>Profissionais da sa√∫de</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="palavras_chave">Palavras-chave (SEO)</label>
                                    <input type="text" id="palavras_chave" name="palavras_chave"
                                        placeholder="Ex: bem-estar, medicina preventiva, manuten√ß√£o preventiva, PMOC...">
                                </div>
                            </div>

                            <div class="form-row form-row--inline">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cta" name="cta">
                                    <label for="cta">Incluir CTA (chamada para a√ß√£o)</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="hashtags" name="hashtags">
                                    <label for="hashtags">Incluir hashtags</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="sugestoes_imagens" name="sugestoes_imagens">
                                    <label for="sugestoes_imagens">Incluir sugest√µes de imagens para o post</label>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group form-group--compact">
                                    <label for="modelo">Modelo de IA</label>
                                    <select id="modelo" name="modelo">
                                        <option value="gpt-4.1-mini">R√°pido (padr√£o)</option>
                                        <option value="gpt-4.1">Profissional</option>
                                    </select>
                                    <smal class="form-help">
                                        <strong>R√°pido (gpt-4.1-mini):</strong> ideal para posts e textos curtos do dia
                                        a dia.<br>
                                        <strong>Profissional (gpt-4.1):</strong> textos mais elaborados, melhores para
                                        SEO e roteiros.
                                    </smal>
                                </div>
                                <div class="form-group form-group--compact">
                                    <label for="temperature">Criatividade</label>
                                    <input type="number" id="temperature" name="temperature" min="0" max="1" step="0.05"
                                        value="0.7">
                                    <small class="form-help">0 = mais objetivo, 1 = mais criativo</small>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn-primary" id="btn-gerar">
                                    Gerar conte√∫do
                                </button>
                                <span class="form-status" id="form-status"></span>
                            </div>
                        </form>
                    </section>

                    <section class="app-result">
                        <div class="app-result__card">
                            <div class="app-result__header">
                                <h2 class="app-result__title">Resultado</h2>
                                <button type="button" class="btn-secondary" id="btn-copiar" disabled>
                                    Copiar texto
                                </button>
                            </div>
                            <div class="app-result__body">
                                <pre id="resultado" class="app-result__content"></pre>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- ABA 2: HIST√ìRICO -->
            <div class="app-tab-pane is-hidden" id="tab-historico">
                <section class="app-panel">
                    <h1 class="app-panel__title">Hist√≥rico de conte√∫dos</h1>

                    <!-- Filtro do hist√≥rico -->
                    <div class="history-filters">
                        <select id="filtro-plataforma">
                            <option value="">Todas as plataformas</option>
                            <option>Instagram (feed)</option>
                            <option>Instagram Reels</option>
                            <option>Facebook (feed)</option>
                            <option>LinkedIn</option>
                            <option>Blog</option>
                            <option>YouTube Shorts</option>
                            <option>TikTok (v√≠deo curto)</option>
                        </select>
                    </div>

                    <div id="historico-lista" class="history-list"></div>
                    <div class="history-actions-global">
                        <button id="btn-export-csv" class="btn-export" onclick="exportarCSV()">
                            Exportar CSV
                        </button>
                        <button id="btn-export-pdf" class="btn-export" onclick="exportarPDF()">
                            Exportar PDF
                        </button>

                    </div>

                </section>
            </div>

            <!-- ABA 3: SOBRE O APP -->
            <div class="app-tab-pane is-hidden" id="tab-sobre">
                <section class="app-about">
                    <h1 class="app-about__title">Sobre o Gerador de Conte√∫do com IA</h1>

                    <p class="app-about__text">
                        Este gerador foi pensado para <strong>profissionais e neg√≥cios</strong> que precisam produzir
                        conte√∫do recorrente,
                        mas n√£o t√™m tempo para escrever tudo do zero.
                    </p>

                    <h2 class="app-about__subtitle">Onde voc√™ pode usar</h2>
                    <ul class="app-about__list">
                        <li>Instagram (feed e Reels)</li>
                        <li>Facebook (feed)</li>
                        <li>LinkedIn</li>
                        <li>Blog</li>
                        <li>Descri√ß√£o de v√≠deos no YouTube</li>
                        <li>YouTube Shorts</li>
                        <li>TikTok (v√≠deos curtos)</li>
                    </ul>

                    <h2 class="app-about__subtitle">Como funciona na pr√°tica</h2>
                    <ol class="app-about__list app-about__list--ordered">
                        <li><strong>Informe o nicho</strong> do seu neg√≥cio (ou do seu cliente).</li>
                        <li><strong>Defina o tema</strong> do conte√∫do que deseja gerar.</li>
                        <li>Escolha a <strong>plataforma</strong>, o <strong>tom</strong>, o <strong>tamanho</strong> e
                            o <strong>p√∫blico-alvo</strong>.</li>
                        <li>Opcionalmente, informe <strong>palavras-chave de SEO</strong>, marque se deseja
                            <strong>CTA</strong>, <strong>hashtags</strong> e <strong>sugest√µes de
                                imagens/cenas</strong>.
                        </li>
                        <li>Clique em <strong>‚ÄúGerar conte√∫do‚Äù</strong> e copie o texto pronto para usar nas suas redes.
                        </li>
                    </ol>

                    <p class="app-about__text">
                        Se a plataforma for de <strong>v√≠deo curto</strong> (Reels / Shorts / TikTok), o app gera
                        tamb√©m:
                    </p>

                    <ul class="app-about__list">
                        <li>Ideia de v√≠deo</li>
                        <li>Roteiro sugerido</li>
                        <li>Sugest√µes de cenas</li>
                        <li>Sugest√µes de m√∫sicas (por estilo)</li>
                    </ul>

                </section>
            </div>

        </div>
    </main>
    <!-- Modal: Limite mensal atingido -->
    <div class="modal-overlay" id="modal-limite">
        <div class="modal">
            <h2 class="modal-title">Limite mensal atingido</h2>

            <p class="modal-text">
                Voc√™ atingiu o limite de gera√ß√£o de conte√∫dos do seu plano neste m√™s.
            </p>

            <ul class="modal-list">
                <li>Aguardar a renova√ß√£o mensal</li>
                <li>Ou fazer upgrade do seu plano</li>
            </ul>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="fecharModalLimite()">
                    Fechar
                </button>
                <a href="https://gerador-conteudo.codertec.com.br/#planos" target="_blank" class="btn-primary">
                    Ver planos
                </a>
            </div>
        </div>
    </div>


    <script>
        window.URL_EXPORT_PDF = "{% url 'export_historico_pdf' %}";
    </script>


    <script>
        window.abrirModalLimite = function () {
            const el = document.getElementById("modal-limite");
            if (!el) return;
            el.classList.add("is-visible");
        };

        window.fecharModalLimite = function () {
            const el = document.getElementById("modal-limite");
            if (!el) return;
            el.classList.remove("is-visible");
        };
    </script>

    <script>
        /* =====================================================
           HELPERS
        ===================================================== */

        function calcularDiasRestantes(dataFim) {
            if (!dataFim) return 0;
            const agora = new Date();
            const fim = new Date(dataFim);
            const diffMs = fim - agora;
            return Math.max(0, Math.ceil(diffMs / (1000 * 60 * 60 * 24)));
        }

        window.atualizarUsoMensal = function (used, limit) {
            const usedEl = document.getElementById("usage-used");
            const limitEl = document.getElementById("usage-limit");
            if (usedEl) usedEl.textContent = used;
            if (limitEl) limitEl.textContent = limit;
        };

        window.abrirModalLimite = function () {
            const el = document.getElementById("modal-limite");
            if (el) el.classList.add("is-visible");
        };

        window.fecharModalLimite = function () {
            const el = document.getElementById("modal-limite");
            if (el) el.classList.remove("is-visible");
        };

        /* =====================================================
           DASHBOARD
        ===================================================== */

        document.addEventListener("DOMContentLoaded", async () => {

            const token = localStorage.getItem("access_token");
            if (!token) {
                window.location.href = "/login/";
                return;
            }

            /* =========================
               PERFIL / PLANO
            ========================= */
            let userData = null;

            try {
                const resp = await fetch("/api/me/", {
                    headers: { Authorization: "Bearer " + token }
                });

                if (!resp.ok) throw new Error();

                userData = await resp.json();
                window.userPlan = userData.plan;

                /* =====================================================
   AVISO FINAL DE TRIAL
===================================================== */

                function mostrarAvisoTrial(userData) {
                    if (
                        userData.subscription_status !== "trial" ||
                        !userData.trial_ends_at
                    ) return;

                    const dias = calcularDiasRestantes(userData.trial_ends_at);
                    if (dias > 3) return;

                    const slot = document.getElementById("trial-banner-slot");
                    if (!slot) return;

                    let titulo = "";
                    let texto = "";
                    let cta = "";
                    let classe = "";

                    if (dias >= 2) {
                        titulo = "‚è≥ Seu teste gratuito est√° acabando";
                        texto = `
            Faltam <strong>${dias} dias</strong> para o fim do seu teste.
            Continue gerando conte√∫dos com IA sem interrup√ß√µes.
        `;
                        cta = "Escolha um plano para continuar";
                        classe = "trial-info";
                    } else if (dias === 1) {
                        titulo = "‚ö†Ô∏è √öltimo dia do seu teste gratuito";
                        texto = `
            Amanh√£ a gera√ß√£o de novos conte√∫dos ser√° bloqueada.
            Fa√ßa o upgrade agora para n√£o perder nada.
        `;
                        cta = "Fazer upgrade agora";
                        classe = "trial-warning";
                    } else {
                        titulo = "üö® Seu teste gratuito terminou";
                        texto = `
            O per√≠odo de teste foi encerrado.
    Ative um plano para continuar gerando conte√∫dos com IA.
        `;
                        cta = "Ativar plano agora";
                        classe = "trial-danger";
                    }

                    slot.innerHTML = `
        <div class="trial-banner ${classe}">
            <div class="trial-banner-content">
                <strong>${titulo}</strong>
                <p>${texto}</p>
                <a
                    href="https://gerador-conteudo.codertec.com.br/#planos"
                    target="_blank"
                    class="btn-primary"
                >
                    ${cta}
                </a>
            </div>
        </div>
    `;
                }

                // üîë CHAMADA REAL (sem isso n√£o aparece)
                mostrarAvisoTrial(userData);


            } catch {
                localStorage.clear();
                window.location.href = "/login/";
                return;
            }


            /* =========================
               USO MENSAL
            ========================= */
            try {
                const usageResp = await fetch("/api/usage/", {
                    headers: { Authorization: "Bearer " + token }
                });

                if (usageResp.ok) {
                    const usage = await usageResp.json();
                    atualizarUsoMensal(usage.used, usage.limit);
                }
            } catch { }

            /* =========================
               AJUSTES DE UI POR PLANO
            ========================= */
            if (window.userPlan === "Basic") {
                const filtros = document.querySelector(".history-filters");
                if (filtros) filtros.style.display = "none";

                const exportBox = document.querySelector(".history-actions-global");
                if (exportBox) exportBox.style.display = "none";
            }

            /* =========================
               LOGOUT
            ========================= */
            const btnLogout = document.getElementById("btn-logout");
            if (btnLogout) {
                btnLogout.onclick = async () => {
                    try {
                        await fetch("/auth/logout/", {
                            method: "POST",
                            headers: {
                                "Authorization": "Bearer " + token,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                refresh: localStorage.getItem("refresh_token")
                            })
                        });
                    } catch { }

                    localStorage.clear();
                    window.location.href = "/login/";
                };
            }

            /* =====================================================
               GERAR CONTE√öDO (FORM)
            ===================================================== */

            const form = document.getElementById("form-briefing");
            if (!form) return;

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const statusEl = document.getElementById("form-status");
                const btn = document.getElementById("btn-gerar");
                const resultadoEl = document.getElementById("resultado");
                const btnCopiar = document.getElementById("btn-copiar");

                statusEl.textContent = "Gerando conte√∫do...";
                btn.disabled = true;

                const payload = {
                    nicho: nicho.value,
                    tema: tema.value,
                    plataforma: plataforma.value,
                    tom: tom.value,
                    tamanho: tamanho.value,
                    publico: publico.value,
                    palavras_chave: palavras_chave.value,
                    cta: cta.checked,
                    hashtags: hashtags.checked,
                    sugestoes_imagens: sugestoes_imagens.checked,
                    modelo: modelo.value,
                    temperature: temperature.value
                };

                try {
                    const response = await fetch("/api/gerar/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + token
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    if (response.status === 429) {
                        atualizarUsoMensal(data.used, data.limit);
                        abrirModalLimite();
                        statusEl.textContent = "";
                        btn.disabled = false;
                        return;
                    }

                    if (!response.ok) {
                        alert(data.error || "Erro ao gerar conte√∫do.");
                        statusEl.textContent = "";
                        btn.disabled = false;
                        return;
                    }

                    resultadoEl.textContent = data.resultado;
                    btnCopiar.disabled = false;
                    atualizarUsoMensal(data.used, data.limit);

                    statusEl.textContent = "Conte√∫do gerado com sucesso!";
                    btn.disabled = false;

                } catch {
                    alert("Erro inesperado ao gerar conte√∫do.");
                    statusEl.textContent = "";
                    btn.disabled = false;
                }
            });

            /* =====================================================
       NAVEGA√á√ÉO / ABAS (CORRIGIDO)
    ===================================================== */

            function abrirAba(tabId) {
                document.querySelectorAll(".app-tab-pane").forEach(pane => {
                    pane.classList.toggle("is-hidden", pane.id !== tabId);
                });
            }

            function ativarMenu(menuEl) {
                document
                    .querySelectorAll(".app-header__nav-item")
                    .forEach(item => item.classList.remove("is-active"));

                if (menuEl) menuEl.classList.add("is-active");
            }

            /* üîë NOVO: sincroniza os bot√µes das abas internas */
            function ativarAbaInterna(tabId) {
                document.querySelectorAll(".app-tabs__button").forEach(btn => {
                    btn.classList.toggle(
                        "is-active",
                        btn.dataset.tab === tabId
                    );
                });
            }

            /* MENU SUPERIOR */
            const navPainel = document.getElementById("nav-painel");
            const navHistorico = document.getElementById("nav-historico");

            if (navPainel) {
                navPainel.addEventListener("click", () => {
                    abrirAba("tab-gerar");
                    ativarMenu(navPainel);
                    ativarAbaInterna("tab-gerar"); // ‚úÖ CORRE√á√ÉO
                });
            }

            if (navHistorico) {
                navHistorico.addEventListener("click", () => {
                    abrirAba("tab-historico");
                    ativarMenu(navHistorico);
                    ativarAbaInterna("tab-historico"); // ‚úÖ CORRE√á√ÉO

                    // üîë ESSENCIAL: sempre carregar o conte√∫do da aba
                    requestAnimationFrame(() => {
                        if (typeof carregarHistorico === "function") {
                            carregarHistorico();
                        }
                    });
                });
            }


            /* ABAS INTERNAS */
            document.querySelectorAll(".app-tabs__button").forEach(btn => {
                btn.addEventListener("click", () => {
                    const tabId = btn.dataset.tab;

                    abrirAba(tabId);

                    // üîë CORRE√á√ÉO: marcar bot√£o ativo corretamente
                    document.querySelectorAll(".app-tabs__button")
                        .forEach(b => b.classList.remove("is-active"));
                    btn.classList.add("is-active");

                    if (tabId === "tab-historico") {
                        requestAnimationFrame(() => {
                            if (typeof carregarHistorico === "function") {
                                carregarHistorico();
                            }
                        });
                    }
                });
            });

            /* =====================================================
   HIST√ìRICO (PLANO BASIC vs CREATOR)
===================================================== */

            window.carregarHistorico = async function () {
                const container = document.getElementById("historico-lista");
                if (!container) return;

                /* üîí PLANO BASIC ‚Äî AVISO + UPGRADE */
                if (window.userPlan === "Basic") {
                    container.innerHTML = `
            <div class="history-locked">
                <h2>Hist√≥rico e exporta√ß√£o em PDF</h2>
                <p>
                    Hist√≥rico dispon√≠vel a partir do <strong>plano Creator</strong>.
                </p>
                <ul>
                    
                    <li>‚úîÔ∏è Exporta√ß√£o em PDF e CSV - No Plano Elite</li>
                    <li>‚úîÔ∏è Organiza√ß√£o por cliente / nicho - No Plano Elite</li>
                </ul>
                <a
                    href="https://gerador-conteudo.codertec.com.br/#planos"
                    target="_blank"
                    class="btn-primary"
                >
                    Fazer upgrade
                </a>
            </div>
        `;
                    return;
                }

                /* üîì PLANOS CREATOR / ELITE */
                const token = localStorage.getItem("access_token");
                container.innerHTML = "<p>Carregando hist√≥rico...</p>";

                try {
                    const response = await fetch("/api/historico/", {
                        headers: { Authorization: "Bearer " + token }
                    });

                    if (!response.ok) {
                        container.innerHTML = "<p>Erro ao carregar hist√≥rico.</p>";
                        return;
                    }

                    const data = await response.json();

                    if (!Array.isArray(data) || data.length === 0) {
                        container.innerHTML = "<p>Nenhum conte√∫do gerado ainda.</p>";
                        return;
                    }

                    container.innerHTML = data.map((item) => `
            <div class="history-item">
                <div class="history-meta">
                    <strong>${item.tema}</strong><br>
                    <small>${item.plataforma}</small>
                </div>
                <pre class="history-content">${item.conteudo}</pre>
            </div>
        `).join("");

                } catch {
                    container.innerHTML = "<p>Erro inesperado ao carregar hist√≥rico.</p>";
                }
            };



        });
    </script>


</body>

</html>